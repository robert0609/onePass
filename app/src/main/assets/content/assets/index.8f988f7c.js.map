{"version":3,"file":"index.8f988f7c.js","sources":["../../src/api/site.ts","../../src/core/business/site/index.ts","../../src/pages/site/edit/index.tsx"],"sourcesContent":["import { ApiError } from '@/core/exception';\nimport ajax from '@/utils/http';\nimport { BaseResponse } from './base';\n\nexport interface Site {\n  id: number;\n  name: string;\n  url: string;\n  level: string;\n}\n\n//#region search\nexport interface SearchRequest {\n  keyword: string;\n  withaccount: boolean;\n}\n\nexport type SearchResponse = BaseResponse<Site[]>;\n\nexport async function search(params: SearchRequest): Promise<SearchResponse> {\n  const res = await ajax.get<SearchResponse>('/webapi/search', params);\n  if (!res.data.isSuccess) {\n    throw ApiError.createApiError(\n      res.data.message ? res.data.message : res.data.errorCode?.toString()\n    );\n  }\n  return res.data;\n}\n//#endregion\n\n//#region getSiteListByLevel\nexport interface GetSiteListByLevelRequest {\n  level: string;\n}\n\nexport type GetSiteListByLevelResponse = BaseResponse<Site[]>;\n\nexport async function getSiteListByLevel(\n  params: GetSiteListByLevelRequest\n): Promise<GetSiteListByLevelResponse> {\n  const res = await ajax.get<GetSiteListByLevelResponse>(\n    '/webapi/site/fetch',\n    params\n  );\n  if (!res.data.isSuccess) {\n    throw ApiError.createApiError(\n      res.data.message ? res.data.message : res.data.errorCode?.toString()\n    );\n  }\n  return res.data;\n}\n//#endregion\n\n//#region getSiteInfoById\nexport interface GetSiteInfoByIdRequest {\n  id: number;\n}\n\nexport type GetSiteInfoByIdResponse = BaseResponse<Site[]>;\n\nexport async function getSiteInfoById(\n  params: GetSiteInfoByIdRequest\n): Promise<GetSiteInfoByIdResponse> {\n  const res = await ajax.get<GetSiteInfoByIdResponse>(\n    '/webapi/site/fetch',\n    params\n  );\n  if (!res.data.isSuccess) {\n    throw ApiError.createApiError(\n      res.data.message ? res.data.message : res.data.errorCode?.toString()\n    );\n  }\n  return res.data;\n}\n//#endregion\n\n//#region updateSiteInfo\nexport interface UpdateSiteInfoRequest {\n  site: Site;\n}\n\nexport type UpdateSiteInfoResponse = BaseResponse;\n\nexport async function updateSiteInfo(\n  params: UpdateSiteInfoRequest\n): Promise<UpdateSiteInfoResponse> {\n  const site = params.site;\n  const res = await ajax.post<UpdateSiteInfoResponse>('/webapi/site/save', {\n    site: JSON.stringify({\n      Id: site.id,\n      Name: encodeURIComponent(site.name),\n      Url: site.url,\n      Level: site.level\n    })\n  });\n  if (!res.data.isSuccess) {\n    throw ApiError.createApiError(\n      res.data.message ? res.data.message : res.data.errorCode?.toString()\n    );\n  }\n  return res.data;\n}\n//#endregion\n","import {\n  getSiteInfoById,\n  getSiteListByLevel,\n  search,\n  Site,\n  updateSiteInfo\n} from '@/api';\nimport { UIError } from '@/core/exception';\nimport { isStringEmpty } from 'roy-type-assert';\nimport { ref, reactive, toRaw } from 'vue';\n\nexport function siteListController() {\n  const id = ref<number>(0);\n  const level = ref<string>('');\n  const keyword = ref<string>('');\n\n  const siteList = ref<Site[]>([]);\n  const currentPageIndex = ref<number>(0);\n  const pageSize = ref<number>(0);\n  const totalPageCount = ref<number>(1);\n  const totalCount = ref<number>(0);\n\n  async function fetchSiteList() {\n    try {\n      // 优先按照siteId来查询\n      if (id.value > 0) {\n        const res = await getSiteInfoById({ id: id.value });\n        siteList.value = res.data;\n        pageSize.value = res.data.length;\n        totalCount.value = res.data.length;\n      } else if (!isStringEmpty(level.value)) {\n        const res = await getSiteListByLevel({ level: level.value });\n        siteList.value = res.data;\n        pageSize.value = res.data.length;\n        totalCount.value = res.data.length;\n      } else if (!isStringEmpty(keyword.value)) {\n        const res = await search({\n          keyword: keyword.value,\n          withaccount: false\n        });\n        siteList.value = res.data;\n        pageSize.value = res.data.length;\n        totalCount.value = res.data.length;\n      } else {\n        throw UIError.createUIError('请设置筛选条件');\n      }\n    } catch (e) {\n      siteList.value = [];\n      currentPageIndex.value = 0;\n      pageSize.value = 0;\n      totalCount.value = 0;\n      throw e;\n    }\n  }\n\n  return {\n    id,\n    level,\n    keyword,\n    siteList,\n    currentPageIndex,\n    pageSize,\n    totalPageCount,\n    totalCount,\n    fetchSiteList\n  };\n}\n\nexport function siteController() {\n  const site = reactive<Site>({\n    id: 0,\n    name: '',\n    url: '',\n    level: ''\n  });\n\n  async function fetchSite() {\n    try {\n      if (site.id > 0) {\n        const res = await getSiteInfoById({\n          id: site.id\n        });\n        if (res.data.length > 0) {\n          site.name = res.data[0].name;\n          site.url = res.data[0].url;\n          site.level = res.data[0].level;\n        } else {\n          throw UIError.createUIError('未查询到网站');\n        }\n      } else {\n        throw UIError.createUIError('请设置网站id');\n      }\n    } catch (e) {\n      site.name = '';\n      site.url = '';\n      site.level = '';\n      throw e;\n    }\n  }\n\n  async function updateSite() {\n    if (isStringEmpty(site.name)) {\n      throw UIError.createUIError('请输入应用名称');\n    }\n    site.level = site.level.toString();\n    if (isStringEmpty(site.level)) {\n      throw UIError.createUIError('请输入应用级别');\n    }\n    try {\n      await updateSiteInfo({\n        site: toRaw(site)\n      });\n    } catch (e) {\n      throw e;\n    }\n  }\n\n  return {\n    site,\n    fetchSite,\n    updateSite\n  };\n}\n","import { defineComponent, ref, onMounted } from 'vue';\nimport { siteController } from '@/core/business/site';\nimport { ElMessage } from 'element-plus';\n\nexport default defineComponent({\n  name: 'SiteEdit',\n  props: {\n    id: {\n      type: Number,\n      required: true\n    },\n    level: {\n      type: String,\n      required: true\n    }\n  },\n  emits: ['confirm', 'cancel'],\n  setup(props, { emit }) {\n    const { site, fetchSite, updateSite } = siteController();\n    const submitLoading = ref<boolean>(false);\n    const refForm = ref<typeof ElForm | null>(null);\n\n    const formRules = {\n      name: [{ required: true, message: '请输入应用名称', trigger: 'blur' }]\n    };\n\n    function onClickSave(): void {\n      if (refForm.value) {\n        submitLoading.value = true;\n        refForm.value.validate((isValid: boolean) => {\n          if (isValid) {\n            updateSite()\n              .then(() => {\n                emit('confirm');\n              })\n              .catch((e) => {\n                ElMessage.error(e.message);\n              })\n              .finally(() => {\n                submitLoading.value = false;\n              });\n          } else {\n            submitLoading.value = false;\n          }\n        });\n      }\n    }\n\n    function onClickCancel() {\n      emit('cancel');\n    }\n\n    onMounted(() => {\n      site.id = props.id;\n      site.level = props.level;\n\n      if (site.id > 0) {\n        fetchSite().catch((e) => {\n          ElMessage.error(e.message);\n        });\n      }\n    });\n\n    return () => (\n      <ElForm\n        model={site}\n        ref={refForm}\n        rules={formRules}\n        labelPosition=\"right\"\n        labelWidth=\"90px\"\n      >\n        <ElFormItem label=\"应用名称\" prop=\"name\">\n          <ElInput\n            {...{\n              modelValue: site.name,\n              ['onUpdate:modelValue']: (val: string) => (site.name = val)\n            }}\n          ></ElInput>\n        </ElFormItem>\n        <ElFormItem label=\"应用地址\" prop=\"url\">\n          <ElInput\n            {...{\n              modelValue: site.url,\n              ['onUpdate:modelValue']: (val: string) => (site.url = val)\n            }}\n          ></ElInput>\n        </ElFormItem>\n        <ElFormItem label=\"应用级别\" prop=\"level\">\n          <ElInput\n            readonly\n            {...{\n              modelValue: site.level,\n              ['onUpdate:modelValue']: (val: string) => (site.level = val)\n            }}\n          ></ElInput>\n        </ElFormItem>\n        <ElFormItem>\n          <ElButton\n            type=\"primary\"\n            onClick={onClickSave}\n            loading={submitLoading.value}\n          >\n            提交\n          </ElButton>\n          <ElButton onClick={onClickCancel}>取消</ElButton>\n        </ElFormItem>\n      </ElForm>\n    );\n  }\n});\n"],"names":["props","setup","updateSite","formRules","trigger","emit","ElMessage","finally","submitLoading","error","modelValue","site"],"mappings":"sLAmB6B,EAAgD,YACrE,GAAM,KAAM,GAAK,IAAoB,iBAAkB,MACzD,CAAC,EAAI,KAAK,eACN,GAAS,eACb,EAAI,KAAK,QAAU,EAAI,KAAK,QAAU,KAAI,KAAK,YAAT,cAAoB,kBAGvD,GAAI,sBAYX,EACqC,YAC/B,GAAM,KAAM,GAAK,IACrB,qBACA,MAEE,CAAC,EAAI,KAAK,eACN,GAAS,eACb,EAAI,KAAK,QAAU,EAAI,KAAK,QAAU,KAAI,KAAK,YAAT,cAAoB,kBAGvD,GAAI,sBAYX,EACkC,YAC5B,GAAM,KAAM,GAAK,IACrB,qBACA,MAEE,CAAC,EAAI,KAAK,eACN,GAAS,eACb,EAAI,KAAK,QAAU,EAAI,KAAK,QAAU,KAAI,KAAK,YAAT,cAAoB,kBAGvD,GAAI,sBAYX,EACiC,YAC3B,GAAO,EAAO,KACd,EAAM,KAAM,GAAK,KAA6B,oBAAqB,CACvE,KAAM,KAAK,UAAU,CACnB,GAAI,EAAK,GACT,KAAM,mBAAmB,EAAK,MAC9B,IAAK,EAAK,IACV,MAAO,EAAK,aAGZ,CAAC,EAAI,KAAK,eACN,GAAS,eACb,EAAI,KAAK,QAAU,EAAI,KAAK,QAAU,KAAI,KAAK,YAAT,cAAoB,kBAGvD,GAAI,iBCzFwB,MAC7B,GAAK,EAAY,GACjB,EAAQ,EAAY,IACpB,EAAU,EAAY,IAEtB,EAAW,EAAY,IACvB,EAAmB,EAAY,GAC/B,EAAW,EAAY,GACvB,EAAiB,EAAY,GAC7B,EAAa,EAAY,qBAEA,IACzB,IAEE,EAAG,MAAQ,EAAG,MACV,GAAM,KAAM,GAAgB,CAAE,GAAI,EAAG,UAClC,MAAQ,EAAI,OACZ,MAAQ,EAAI,KAAK,SACf,MAAQ,EAAI,KAAK,eAClB,EAAc,EAAM,WAKpB,EAAc,EAAQ,YAS1B,GAAQ,cAAc,8CATY,MAClC,GAAM,KAAM,GAAO,CACvB,QAAS,EAAQ,MACjB,YAAa,OAEN,MAAQ,EAAI,OACZ,MAAQ,EAAI,KAAK,SACf,MAAQ,EAAI,KAAK,YAZU,MAChC,GAAM,KAAM,GAAmB,CAAE,MAAO,EAAM,UAC3C,MAAQ,EAAI,OACZ,MAAQ,EAAI,KAAK,SACf,MAAQ,EAAI,KAAK,cAYvB,WACE,MAAQ,KACA,MAAQ,IAChB,MAAQ,IACN,MAAQ,EACb,SAIH,CACL,KACA,QACA,UACA,WACA,mBACA,WACA,iBACA,aACA,6BAI6B,MACzB,GAAO,EAAe,CAC1B,GAAI,EACJ,KAAM,GACN,IAAK,GACL,MAAO,uBAGkB,IACrB,IACE,EAAK,GAAK,EAAG,MACT,GAAM,KAAM,GAAgB,CAChC,GAAI,EAAK,QAEP,EAAI,KAAK,OAAS,IACf,KAAO,EAAI,KAAK,GAAG,OACnB,IAAM,EAAI,KAAK,GAAG,MAClB,MAAQ,EAAI,KAAK,GAAG,gBAEnB,GAAQ,cAAc,kDAGxB,GAAQ,cAAc,0CAEvB,WACF,KAAO,KACP,IAAM,KACN,MAAQ,GACP,qBAIkB,IACtB,EAAc,EAAK,WACf,GAAQ,cAAc,mDAEzB,MAAQ,EAAK,MAAM,WACpB,EAAc,EAAK,YACf,GAAQ,cAAc,iDAE1B,MACI,GAAe,CACnB,KAAM,EAAM,WAEP,QACD,UAIH,CACL,OACA,YACA,cClHFA,cACM,gFAUNC,mDAC2BC,qCAInBC,QACA,YAAG,QAAsCC,+FAK3C,8BAGc,aAENC,gBAGAC,eAEDC,UACCC,8HAmBNF,KAAUG,iEASLN,oeAwBDO,SAAYC,IACX"}